#!/bin/bash

set -e

fcopy -r /etc/fai

if [ $FAI_ACTION != "install" ]; then
    exit 0
fi
fcopy  /etc/rc.local


## Generate the DHCP configuration file 'dhcpd.conf'.
## Use variables from corresponding class/*.var file.

mv $target/etc/dhcp/dhcpd.conf $target/etc/dhcp/dhcpd.conf_orig

cat > $target/etc/dhcp/dhcpd.conf <<EOF
# dhcpd.conf generated by $0

option dhcp-max-message-size 2048;
use-host-decl-names on;

option routers ${GATEWAY};
option domain-name "intern";
option domain-name-servers ${NAMESERVER_IPADDR};
option ntp-servers ntp;

subnet ${SUBNET} netmask ${NETMASK} {
   allow unknown-clients;
   range ${RANGE};
   server-name faiserver;
   next-server faiserver;
   filename "fai/pxelinux.0";
}

group {
   server-name faiserver;
   next-server faiserver;
   filename "fai/pxelinux.0";
EOF

PREFIX=`echo $SUBNET | cut -d "." --fields=1,2,3`

for i in `seq 50 149` ; do
    NUM=`printf "%02d" $(($i-50))`
    IPADDR=$i
    echo "   host workstation$NUM {hardware ethernet A1:B2:C3:D4:E5:$NUM; fixed-address $PREFIX.$IPADDR;}" \
	>> $target/etc/dhcp/dhcpd.conf
done
echo >> $target/etc/dhcp/dhcpd.conf
for i in `seq 150 249` ; do
    NUM=`printf "%02d" $(($i-150))`
    IPADDR=$i
    echo "   host diskless$NUM {hardware ethernet A1:B2:C3:D4:E5:$NUM; fixed-address $PREFIX.$IPADDR;}" \
	>> $target/etc/dhcp/dhcpd.conf
done
echo "}" >> $target/etc/dhcp/dhcpd.conf
